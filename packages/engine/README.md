# BroadwayEngine

** TODO **

- Add real offer car function
- add "busy" property on car when making an offer
- Change so we don't use birds eye view, use OSRM route distance instead.

# Select broadway engine gameplan

- [x] Rename all broadway engine -> engine
- [x] Rename old engine-elixir + engine to -> engine-old, engine-js
- [x] Rename order -> booking
- [x] Rename car -> vehicle
- [ ] Rename cars exchange -> vehicles
- [x] Rename graphhopper -> candidates_request + candidates_response
- [x] Produce multiple [bookings] + [vehicles] into a candidates_request according to this [format](https://docs.graphhopper.com/#tag/Route-Optimization-API)
      (we already do this)
- [ ] Produce multiple bookings from the match_producer
      -> 5 cars + 10 bookings -> candidate_request[5, 10] -> candidate_response[5, 10] -> offer -> accept[3, 5] + remainder[2, 5] -> candidate_request[2, 5] + new
- [ ] If some producer needs to send metadata they should include it in a meta property
- [ ] Offer the vehicles the bookings and gather the response
- [x] Dockerfile + yaml for running in test environment
- [x] Remove unused code from car (route_score, permutations etc)
- [ ] Profit!

# Proposed changes on Vehicle:

- [x] rename orsm_route to current_route (Description: current suggested route)
- [x] id should be generated by our system and stored persistent (aka not just in memory)
- [x] id is also the GenServer identifier
- [x] standardize our ID format to something like "pmv-3151"
- [x] remove external_id
- [x] remove heading
- [x] rename instructions to activities
- [x] structure 'metadata' to have child properties like 'telegram', 'postnord'
- [ ] change external_id into some sort of id and include in metadata.telegram

# Proposed changes on Booking:

- [x] id should be generated by our system and stored persistent (aka not just in memory)
- [x] id is also the GenServer identifier
- [x] standardize our ID format to something like "pmb-3151"
- [x] use elixir uuid library for id generation and convert to base62 representation for readability
- [x] structure 'metadata' to have child properties like 'telegram', 'postnord'
- [x] ignore senderId and store everything in metadata.telegram
- [ ] DO NOT STORE routes on a bookings
- [ ] assigned_to is a vehicle id
- [x] add events list (First element is the latest event)

# Proposed changes:

- [ ] Rename candidates to plan
- [ ] Plan currently should just be a dump from graphhopper api
- [x] Offer all bookings to a vehicle in 1 request
- [x] On a vehicle after the driver accepted all the bookings, current_route is a route calculated by using all activities
- [ ] Add events on Vehicle

# Outcome:

```elixir
%Vehicle{
  id: "pmv-1337",
  booking_ids: [],
  busy: false,
  activities: [],
  current_route: %{},
  position: %{lat: 61.764477, lon: 16.015386},
  metadata: %{
    postnord: {
      vehicleId: 5542329
    }
  }
}

%Booking{
  assigned_to: "pmv-1337",
  delivery: %{lat: 61.861276, lon: 15.959858},
  id: "pmb-2357",
  external_id: "POSTNORD-139u33",
  pickup: %{lat: 61.731184, lon: 16.032504},
  metadata: %{
    telegram: {
      senderId: 70397
    }
  },
  events: [%{
    timestamp: '2020-01-...',
    type: :delivered
  }, %{
    timestamp: '2020-01-...',
    type: :picked_up
  }, %{
    timestamp: '2020-01-...',
    type: :assigned
  }, %{
    timestamp: '2020-01-...',
    type: :created
  }]
}
```
